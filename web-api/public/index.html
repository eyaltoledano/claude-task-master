<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Master Web API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-connected {
            background-color: #4CAF50;
            color: white;
        }

        .status-mock {
            background-color: #FF9800;
            color: white;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab-content {
            padding: 30px;
            min-height: 500px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .info-group {
            margin-bottom: 15px;
        }

        .info-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .info-value {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            color: #495057;
            word-break: break-all;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,193,7,0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23,162,184,0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .response-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #007bff;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .task-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .task-detail {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .task-detail h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1rem;
        }

        .task-detail .loading {
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        .task-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-id {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .task-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-done {
            background: #d4edda;
            color: #155724;
        }

        .status-in-progress {
            background: #cce5ff;
            color: #004085;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #343a40;
        }

        .task-description {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .file-upload-area.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card-header {
            font-weight: 600;
            margin-bottom: 15px;
            color: #343a40;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .form-check {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-check-input {
            margin-right: 8px;
        }

        .form-check-label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .config-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .config-section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* 状态分组样式 */
        .status-group {
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            font-weight: 600;
            border-radius: 8px 8px 0 0;
        }

        .status-tasks {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
        }

        .task-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .toggle-icon {
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .status-tasks.collapsed {
            display: none !important;
        }

        .status-header:hover {
            filter: brightness(1.1);
        }

        /* 增强任务项样式 */
        .task-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .task-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .task-item:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-content {
                padding: 20px;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
            
            .status-header {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .task-count {
                align-self: center;
            }
            
            .btn-group {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .btn-group .btn {
                flex: 1;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- <h1>🚀 Task Master Web API</h1>
            <p>强大的任务管理和AI辅助开发平台</p> -->
            <span id="statusIndicator" class="status-indicator status-mock">🔄 检查连接中...</span>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" data-tab="config">⚙️ 配置</button>
                <button class="tab" data-tab="tasks">📋 任务管理</button>
                <button class="tab" data-tab="projects">🏗️ 项目管理</button>
                <button class="tab" data-tab="research">🔬 AI研究</button>
                <button class="tab" data-tab="docs">📚 API文档</button>
            </div>

            <!-- 配置标签页 -->
            <div class="tab-content">
                <div class="tab-pane active" id="config">
                    <!-- 系统状态 -->
                    <div class="config-section">
                        <h3>📊 系统状态</h3>
                        <div class="grid">
                            <div class="card">
                                <div class="card-header">连接状态</div>
                                <div id="systemStatus">
                                    <p>点击"测试连接"来检查系统状态</p>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">API统计</div>
                                <div id="apiStats">
                                    <button class="btn btn-info" onclick="loadApiStats()">📈 获取统计信息</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 项目配置 -->
                    <div class="config-section">
                        <h3>🏗️ 项目配置</h3>
                        <div class="grid">
                            <div class="card">
                                <div class="card-header">当前项目信息</div>
                                <div id="projectInfo">
                                    <button class="btn btn-info" onclick="loadProjectInfo()">📋 加载项目信息</button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">标签管理</div>
                                <div id="tagsInfo">
                                    <button class="btn btn-info" onclick="loadTagsInfo()">🏷️ 加载标签信息</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI模型配置 -->
                    <div class="config-section">
                        <h3>🤖 AI模型配置</h3>
                        <div class="alert alert-info">
                            <strong>ℹ️ 提示：</strong> AI模型配置需要联系管理员进行修改
                        </div>
                        <div class="grid">
                            <div class="card">
                                <div class="card-header">主要模型 (Main)</div>
                                <div class="info-group">
                                    <label>当前模型</label>
                                    <div class="info-value" id="currentMainModel">加载中...</div>
                                </div>
                                <div class="info-group">
                                    <label>Base URL</label>
                                    <div class="info-value" id="currentMainBaseUrl">加载中...</div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">研究模型 (Research)</div>
                                <div class="info-group">
                                    <label>当前模型</label>
                                    <div class="info-value" id="currentResearchModel">加载中...</div>
                                </div>
                                <div class="info-group">
                                    <label>Base URL</label>
                                    <div class="info-value" id="currentResearchBaseUrl">加载中...</div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">后备模型 (Fallback)</div>
                                <div class="info-group">
                                    <label>当前模型</label>
                                    <div class="info-value" id="currentFallbackModel">加载中...</div>
                                </div>
                                <div class="info-group">
                                    <label>Base URL</label>
                                    <div class="info-value" id="currentFallbackBaseUrl">加载中...</div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-info" onclick="loadAiConfig()">🔄 刷新AI配置信息</button>
                    </div>

                    <!-- API配置 -->
                    <div class="config-section">
                        <h3>🔑 API配置</h3>
                        <div class="alert alert-info">
                            <strong>🔒 安全提示：</strong> API密钥将在本地保存24小时，无需重复输入。24小时后将自动清除以确保安全。
                        </div>
                        <div class="form-group">
                            <label for="apiKey">API密钥</label>
                            <input type="password" id="apiKey" class="form-control" value="" placeholder="输入您的API密钥">
                        </div>
                        <div class="form-group">
                            <label for="baseUrl">API基础URL</label>
                            <input type="text" id="baseUrl" class="form-control" value="http://localhost:3000" placeholder="http://localhost:3000">
                        </div>
                        <button class="btn btn-primary" onclick="testConnection()">🔍 测试连接</button>
                    </div>


                </div>

                <!-- 任务管理标签页 -->
                <div class="tab-pane" id="tasks">
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="loadTasks()">📋 获取任务列表</button>
                        <button class="btn btn-success" onclick="getNextTask()">⏭️ 下一个任务</button>
                        <button class="btn btn-info" onclick="showCreateTaskForm()">➕ 创建任务</button>
                        <button class="btn btn-warning" onclick="toggleAllStatusGroups()" id="toggleAllBtn" style="display: none;">📂 全部折叠</button>
                    </div>

                    <div id="createTaskForm" style="display: none;" class="config-section">
                        <h4>创建新任务</h4>
                        <div class="form-group">
                            <label for="taskPrompt">任务描述</label>
                            <textarea id="taskPrompt" class="form-control" rows="3" placeholder="描述您要创建的任务..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="taskPriority">优先级</label>
                            <select id="taskPriority" class="form-control">
                                <option value="medium">中等</option>
                                <option value="high">高</option>
                                <option value="low">低</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskDependencies">依赖任务ID (逗号分隔)</label>
                            <input type="text" id="taskDependencies" class="form-control" placeholder="例如: 1,2,3">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="createTask()">✅ 创建任务</button>
                            <button class="btn btn-warning" onclick="hideCreateTaskForm()">❌ 取消</button>
                        </div>
                    </div>

                    <div id="tasksContainer">
                        <p class="text-center">点击"获取任务列表"来加载任务</p>
                    </div>
                </div>

                <!-- 项目管理标签页 -->
                <div class="tab-pane" id="projects">
                    <div class="grid">
                        <div class="card">
                            <div class="card-header">🏗️ 项目初始化</div>
                            <div class="form-group">
                                <label for="projectName">项目名称</label>
                                <input type="text" id="projectName" class="form-control" placeholder="我的项目">
                            </div>
                            <div class="form-group">
                                <label for="projectDescription">项目描述</label>
                                <textarea id="projectDescription" class="form-control" rows="3" placeholder="项目描述..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="projectVersion">版本</label>
                                <input type="text" id="projectVersion" class="form-control" value="1.0.0" placeholder="1.0.0">
                            </div>
                            <button class="btn btn-primary" onclick="initializeProject()">🚀 初始化项目</button>
                        </div>

                        <div class="card">
                            <div class="card-header">📄 PRD解析</div>
                            <div class="form-group">
                                <label for="prdContent">PRD内容</label>
                                <textarea id="prdContent" class="form-control" rows="6" placeholder="输入产品需求文档内容...&#10;例如：创建一个用户管理系统，包含用户注册、登录、个人资料管理等功能..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="numTasks">生成任务数量</label>
                                <input type="number" id="numTasks" class="form-control" value="5" min="1" max="20">
                            </div>
                            <button class="btn btn-success" onclick="parsePrd()">🔄 解析PRD</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">📁 PRD文件上传</div>
                        <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('prdFile').click()">
                            <div>
                                <h4>📁 点击或拖拽上传PRD文件</h4>
                                <p>支持 .txt, .md 等文本文件，最大10MB</p>
                            </div>
                            <input type="file" id="prdFile" style="display: none;" accept=".txt,.md,.text" onchange="handleFileSelect(event)">
                        </div>
                        <button class="btn btn-info" onclick="uploadPrdFile()" id="uploadBtn" disabled>📤 上传并解析</button>
                    </div>
                </div>

                <!-- AI研究标签页 -->
                <div class="tab-pane" id="research">
                    <div class="config-section">
                        <h3>🔬 AI研究查询</h3>
                        <div class="form-group">
                            <label for="researchQuery">研究问题</label>
                            <textarea id="researchQuery" class="form-control" rows="3" placeholder="输入您想研究的问题...&#10;例如：React Hook的最佳实践有哪些？"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="detailLevel">详细程度</label>
                            <select id="detailLevel" class="form-control">
                                <option value="medium">中等</option>
                                <option value="high">详细</option>
                                <option value="low">简要</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="customContext">自定义上下文 (可选)</label>
                            <textarea id="customContext" class="form-control" rows="2" placeholder="提供额外的上下文信息..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="performResearch()">🔍 开始研究</button>
                    </div>

                    <div id="researchResults">
                        <p class="text-center">输入研究问题并点击"开始研究"来获取AI分析结果</p>
                    </div>
                </div>

                <!-- API文档标签页 -->
                <div class="tab-pane" id="docs">
                    <div class="config-section">
                        <h3>📚 API文档</h3>
                        <p>Task Master Web API 提供了完整的任务管理功能。</p>
                        
                        <h4>🔗 快速链接</h4>
                        <div class="btn-group">
                            <a href="/docs" target="_blank" class="btn btn-primary">📖 Swagger文档</a>
                            <a href="/debug/routes" target="_blank" class="btn btn-info">🔍 调试信息</a>
                            <button class="btn btn-success" onclick="loadApiDocs()">📋 获取路由列表</button>
                        </div>
                    </div>

                    <div id="apiDocsContainer">
                        <p class="text-center">点击"获取路由列表"来查看可用的API端点</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 加载指示器 -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>处理中，请稍候...</p>
        </div>

        <!-- 响应区域 -->
        <div class="response-area" id="responseArea" style="display: none;"></div>
    </div>

    <script>
        // 全局配置
        let config = {
            apiKey: 'test-api-key-123',
            baseUrl: 'http://localhost:3000'
        };

        let selectedFile = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            loadConfig();
            loadAiConfig();
            testConnection();
            setupFileUpload();
        });

        // 标签页功能
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const panes = document.querySelectorAll('.tab-pane');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    
                    // 移除所有活动状态
                    tabs.forEach(t => t.classList.remove('active'));
                    panes.forEach(p => p.classList.remove('active'));
                    
                    // 添加活动状态
                    tab.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        }

        // 加载配置
        function loadConfig() {
            // 检查API密钥是否在24小时内保存过
            const savedApiKeyData = localStorage.getItem('taskmaster_api_key_data');
            const savedBaseUrl = localStorage.getItem('taskmaster_base_url');
            
            if (savedApiKeyData) {
                try {
                    const keyData = JSON.parse(savedApiKeyData);
                    const now = Date.now();
                    const twentyFourHours = 24 * 60 * 60 * 1000; // 24小时的毫秒数
                    
                    // 检查是否在24小时内
                    if (now - keyData.timestamp < twentyFourHours) {
                        document.getElementById('apiKey').value = keyData.apiKey;
                        config.apiKey = keyData.apiKey;
                    } else {
                        // 超过24小时，清除保存的密钥
                        localStorage.removeItem('taskmaster_api_key_data');
                        localStorage.removeItem('taskmaster_api_key'); // 清除旧格式
                    }
                } catch (e) {
                    // 如果解析失败，检查是否有旧格式的数据
                    const oldApiKey = localStorage.getItem('taskmaster_api_key');
                    if (oldApiKey) {
                        // 迁移旧数据到新格式
                        saveApiKeyWithTimestamp(oldApiKey);
                        document.getElementById('apiKey').value = oldApiKey;
                        config.apiKey = oldApiKey;
                        localStorage.removeItem('taskmaster_api_key'); // 清除旧格式
                    }
                }
            }
            
            if (savedBaseUrl) {
                document.getElementById('baseUrl').value = savedBaseUrl;
                config.baseUrl = savedBaseUrl;
            }
        }

        // 保存API密钥（带时间戳）
        function saveApiKeyWithTimestamp(apiKey) {
            const keyData = {
                apiKey: apiKey,
                timestamp: Date.now()
            };
            localStorage.setItem('taskmaster_api_key_data', JSON.stringify(keyData));
        }

        // 保存配置
        function saveConfig() {
            const apiKey = document.getElementById('apiKey').value;
            config.apiKey = apiKey;
            config.baseUrl = document.getElementById('baseUrl').value;
            
            // 只有在API密钥不为空时才保存
            if (apiKey.trim()) {
                saveApiKeyWithTimestamp(apiKey);
            }
            
            localStorage.setItem('taskmaster_base_url', config.baseUrl);
        }

        // API请求函数
        async function apiRequest(endpoint, options = {}) {
            saveConfig();
            
            const url = `${config.baseUrl}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': config.apiKey
                }
            };
            
            const requestOptions = { ...defaultOptions, ...options };
            if (options.headers) {
                requestOptions.headers = { ...defaultOptions.headers, ...options.headers };
            }
            
            try {
                showLoading(true);
                const response = await fetch(url, requestOptions);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('API请求失败:', error);
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // 显示/隐藏加载指示器
        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            if (show) {
                indicator.classList.add('show');
            } else {
                indicator.classList.remove('show');
            }
        }

        // 显示响应
        function showResponse(data, title = '响应结果') {
            const responseArea = document.getElementById('responseArea');
            responseArea.style.display = 'block';
            responseArea.innerHTML = `<h4>${title}</h4>\n${JSON.stringify(data, null, 2)}`;
            responseArea.scrollIntoView({ behavior: 'smooth' });
        }

        // 显示通知
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.tab-pane.active');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // 测试连接
        async function testConnection() {
            try {
                // 首先验证API密钥是否为空
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    throw new Error('API密钥不能为空，请先配置API密钥');
                }
                
                // 使用实际的API端点测试连接和API密钥
                const data = await apiRequest('/health');
                
                const statusIndicator = document.getElementById('statusIndicator');
                const systemStatus = document.getElementById('systemStatus');
                
                if (data.success) {
                    statusIndicator.textContent = data.taskMasterIntegrated ? 
                        '✅ 已连接 (真实数据)' : '⚠️ 已连接 (模拟数据)';
                    statusIndicator.className = data.taskMasterIntegrated ? 
                        'status-indicator status-connected' : 'status-indicator status-mock';
                    
                    systemStatus.innerHTML = `
                        <div class="alert alert-success">
                            <strong>✅ 连接成功!</strong><br>
                            状态: ${data.status}<br>
                            时间: ${new Date(data.timestamp).toLocaleString()}<br>
                            Task Master集成: ${data.taskMasterIntegrated ? '真实核心' : '模拟数据'}
                        </div>
                    `;
                    
                    showAlert('连接测试成功!', 'success');
                } else {
                    throw new Error('健康检查失败');
                }
            } catch (error) {
                const statusIndicator = document.getElementById('statusIndicator');
                const systemStatus = document.getElementById('systemStatus');
                
                statusIndicator.textContent = '❌ 连接失败';
                statusIndicator.className = 'status-indicator alert-error';
                
                systemStatus.innerHTML = `
                    <div class="alert alert-error">
                        <strong>❌ 连接失败!</strong><br>
                        错误: ${error.message}
                    </div>
                `;
                
                showAlert(`连接失败: ${error.message}`, 'error');
            }
        }

        // 任务管理功能
        async function loadTasks() {
            try {
                const data = await apiRequest('/api/tasks');
                displayTasks(data.data.tasks);
                showAlert('任务列表加载成功!', 'success');
            } catch (error) {
                showAlert(`加载任务失败: ${error.message}`, 'error');
            }
        }

        function displayTasks(tasks) {
            const container = document.getElementById('tasksContainer');
            
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p class="text-center">暂无任务</p>';
                return;
            }
            
            // 按状态分组任务
            const groupedTasks = {
                'pending': [],
                'in-progress': [],
                'done': [],
                'blocked': [],
                'cancelled': [],
                'deferred': [],
                'review': [],
                'other': []
            };
            
            tasks.forEach(task => {
                const status = task.status || 'other';
                if (groupedTasks[status]) {
                    groupedTasks[status].push(task);
                } else {
                    groupedTasks['other'].push(task);
                }
            });
            
            // 状态显示顺序和配置
            const statusConfig = {
                'pending': { title: '📋 待处理', color: '#ffc107', count: groupedTasks['pending'].length },
                'in-progress': { title: '🔄 进行中', color: '#007bff', count: groupedTasks['in-progress'].length },
                'review': { title: '👀 复查中', color: '#fd7e14', count: groupedTasks['review'].length },
                'done': { title: '✅ 已完成', color: '#28a745', count: groupedTasks['done'].length },
                'blocked': { title: '🚫 阻塞', color: '#dc3545', count: groupedTasks['blocked'].length },
                'deferred': { title: '⏸️ 延迟', color: '#6f42c1', count: groupedTasks['deferred'].length },
                'cancelled': { title: '❌ 已取消', color: '#6c757d', count: groupedTasks['cancelled'].length },
                'other': { title: '📝 其他', color: '#6c757d', count: groupedTasks['other'].length }
            };
            
            let html = '';
            
            // 生成每个状态分组
            Object.keys(statusConfig).forEach(status => {
                const config = statusConfig[status];
                const statusTasks = groupedTasks[status];
                
                                 if (statusTasks.length > 0) {
                     html += `
                         <div class="status-group" style="margin-bottom: 30px;">
                             <div class="status-header" onclick="toggleStatusGroup('${status}')" style="
                                 background: ${config.color};
                                 color: white;
                                 padding: 12px 20px;
                                 border-radius: 8px 8px 0 0;
                                 font-weight: 600;
                                 display: flex;
                                 justify-content: space-between;
                                 align-items: center;
                                 cursor: pointer;
                                 user-select: none;
                                 transition: all 0.3s ease;
                             " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                                 <span>
                                     <span id="toggle-icon-${status}" class="toggle-icon">▼</span>
                                     ${config.title}
                                 </span>
                                 <span class="task-count">${config.count} 个任务</span>
                             </div>
                             <div class="status-tasks" id="status-tasks-${status}" style="
                                 border: 2px solid ${config.color};
                                 border-top: none;
                                 border-radius: 0 0 8px 8px;
                                 padding: 15px;
                                 background: #f8f9fa;
                                 display: block;
                                 transition: all 0.3s ease;
                             ">
                     `;
                    
                    statusTasks.forEach(task => {
                        html += `
                            <div class="task-item" id="task-${task.id}" style="
                                background: white;
                                border: 1px solid #dee2e6;
                                border-radius: 8px;
                                padding: 15px;
                                margin-bottom: 15px;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            ">
                                <div class="task-header">
                                    <div>
                                        <span class="task-id">#${task.id}</span>
                                        <span class="task-status status-${task.status}">${getStatusText(task.status)}</span>
                                    </div>
                                    <div class="btn-group" style="gap: 5px;">
                                        <button class="btn btn-info" style="padding: 5px 10px; font-size: 0.8rem;" onclick="toggleTaskDetail('${task.id}')" id="detail-btn-${task.id}">详情</button>
                                        ${getActionButtons(task.status, task.id)}
                                    </div>
                                </div>
                                <div class="task-title">${task.title}</div>
                                <div class="task-description">${task.description}</div>
                                ${task.priority ? `<div style="margin-top: 10px;"><small>优先级: ${getPriorityText(task.priority)}</small></div>` : ''}
                                <div class="task-detail" id="detail-${task.id}" style="display: none;">
                                    <div class="loading">加载详情中...</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                container.innerHTML = '<p class="text-center">暂无任务</p>';
                // 隐藏全部展开/折叠按钮
                const toggleBtn = document.getElementById('toggleAllBtn');
                if (toggleBtn) {
                    toggleBtn.style.display = 'none';
                }
            } else {
                container.innerHTML = html;
                // 显示并更新全部展开/折叠按钮
                updateToggleAllButton();
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '待处理',
                'in-progress': '进行中',
                'done': '已完成',
                'blocked': '阻塞',
                'cancelled': '已取消',
                'deferred': '延迟',
                'review': '复查中'
            };
            return statusMap[status] || status;
        }

        function getPriorityText(priority) {
            const priorityMap = {
                'high': '高',
                'medium': '中',
                'low': '低'
            };
            return priorityMap[priority] || priority;
        }

        function getActionButtons(status, taskId) {
            const buttons = [];
            
            switch (status) {
                case 'pending':
                    buttons.push(`<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'in-progress')">开始</button>`);
                    buttons.push(`<button class="btn btn-success" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'done')">完成</button>`);
                    break;
                case 'in-progress':
                    buttons.push(`<button class="btn btn-success" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'done')">完成</button>`);
                    buttons.push(`<button class="btn btn-warning" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'review')">复查</button>`);
                    buttons.push(`<button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'pending')">暂停</button>`);
                    break;
                case 'review':
                    buttons.push(`<button class="btn btn-success" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'done')">通过</button>`);
                    buttons.push(`<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'in-progress')">继续</button>`);
                    break;
                case 'blocked':
                    buttons.push(`<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'in-progress')">解锁</button>`);
                    break;
                case 'deferred':
                    buttons.push(`<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'pending')">恢复</button>`);
                    break;
                case 'done':
                    buttons.push(`<button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'pending')">重开</button>`);
                    break;
                case 'cancelled':
                    buttons.push(`<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'pending')">恢复</button>`);
                    break;
                default:
                    buttons.push(`<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="updateTaskStatus('${taskId}', 'in-progress')">开始</button>`);
                    break;
            }
            
            return buttons.join('');
        }

        function toggleStatusGroup(status) {
            const tasksContainer = document.getElementById(`status-tasks-${status}`);
            const toggleIcon = document.getElementById(`toggle-icon-${status}`);
            
            if (tasksContainer && toggleIcon) {
                const isCollapsed = tasksContainer.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // 展开
                    tasksContainer.classList.remove('collapsed');
                    toggleIcon.classList.remove('collapsed');
                    toggleIcon.textContent = '▼';
                } else {
                    // 折叠
                    tasksContainer.classList.add('collapsed');
                    toggleIcon.classList.add('collapsed');
                    toggleIcon.textContent = '▶';
                }
                
                // 更新全部展开/折叠按钮状态
                updateToggleAllButton();
            }
        }

        function toggleAllStatusGroups() {
            const statusGroups = document.querySelectorAll('.status-tasks');
            const toggleBtn = document.getElementById('toggleAllBtn');
            
            if (statusGroups.length === 0) return;
            
            // 检查当前状态 - 如果有任何一个是展开的，则全部折叠；否则全部展开
            const hasExpanded = Array.from(statusGroups).some(group => !group.classList.contains('collapsed'));
            
            statusGroups.forEach(group => {
                const groupId = group.id;
                const status = groupId.replace('status-tasks-', '');
                const toggleIcon = document.getElementById(`toggle-icon-${status}`);
                
                if (hasExpanded) {
                    // 全部折叠
                    group.classList.add('collapsed');
                    if (toggleIcon) {
                        toggleIcon.classList.add('collapsed');
                        toggleIcon.textContent = '▶';
                    }
                } else {
                    // 全部展开
                    group.classList.remove('collapsed');
                    if (toggleIcon) {
                        toggleIcon.classList.remove('collapsed');
                        toggleIcon.textContent = '▼';
                    }
                }
            });
            
            // 更新按钮文本
            updateToggleAllButton();
        }

        function updateToggleAllButton() {
            const statusGroups = document.querySelectorAll('.status-tasks');
            const toggleBtn = document.getElementById('toggleAllBtn');
            
            if (statusGroups.length === 0) {
                toggleBtn.style.display = 'none';
                return;
            }
            
            const hasExpanded = Array.from(statusGroups).some(group => !group.classList.contains('collapsed'));
            
            if (hasExpanded) {
                toggleBtn.textContent = '📂 全部折叠';
                toggleBtn.className = 'btn btn-warning';
            } else {
                toggleBtn.textContent = '📂 全部展开';
                toggleBtn.className = 'btn btn-secondary';
            }
            
            toggleBtn.style.display = 'inline-block';
        }

        async function getNextTask() {
            try {
                const response = await apiRequest('/api/tasks/next');
                // 安全地检查响应数据结构
                if (response && response.data && response.data.nextTask) {
                    displayTasks([response.data.nextTask]);
                    showAlert('下一个任务获取成功!', 'success');
                } else {
                    showAlert('暂无可执行的下一个任务', 'info');
                    // 清空任务容器
                    document.getElementById('tasksContainer').innerHTML = '<p class="text-center">暂无可执行的下一个任务</p>';
                }
            } catch (error) {
                showAlert(`获取下一个任务失败: ${error.message}`, 'error');
            }
        }

        async function toggleTaskDetail(taskId) {
            const detailDiv = document.getElementById(`detail-${taskId}`);
            const detailBtn = document.getElementById(`detail-btn-${taskId}`);
            
            if (detailDiv.style.display === 'none') {
                // 展开详情
                detailDiv.style.display = 'block';
                detailBtn.textContent = '收起';
                detailBtn.classList.remove('btn-info');
                detailBtn.classList.add('btn-secondary');
                
                // 加载详情数据
                try {
                    detailDiv.innerHTML = '<div class="loading">加载详情中...</div>';
                    const data = await apiRequest(`/api/tasks/${taskId}`);
                    
                    // 格式化显示详情
                    const task = data.data.task || data.data;
                    let detailHtml = `<h4>任务 #${taskId} 详情</h4>`;
                    detailHtml += `<strong>标题:</strong> ${task.title || '无'}\n`;
                    detailHtml += `<strong>描述:</strong> ${task.description || '无'}\n`;
                    detailHtml += `<strong>状态:</strong> ${getStatusText(task.status)}\n`;
                    if (task.priority) {
                        detailHtml += `<strong>优先级:</strong> ${getPriorityText(task.priority)}\n`;
                    }
                    if (task.dependencies && task.dependencies.length > 0) {
                        detailHtml += `<strong>依赖:</strong> ${task.dependencies.join(', ')}\n`;
                    }
                    if (task.details) {
                        detailHtml += `<strong>实现细节:</strong>\n${task.details}\n`;
                    }
                    if (task.testStrategy) {
                        detailHtml += `<strong>测试策略:</strong>\n${task.testStrategy}\n`;
                    }
                    if (task.subtasks && task.subtasks.length > 0) {
                        detailHtml += `<strong>子任务:</strong>\n`;
                        task.subtasks.forEach((subtask, index) => {
                            detailHtml += `${index + 1}. [${getStatusText(subtask.status)}] ${subtask.title}\n`;
                            if (subtask.description) {
                                detailHtml += `   ${subtask.description}\n`;
                            }
                        });
                    }
                    
                    detailDiv.innerHTML = detailHtml;
                } catch (error) {
                    detailDiv.innerHTML = `<div style="color: #dc3545;">加载详情失败: ${error.message}</div>`;
                }
            } else {
                // 收起详情
                detailDiv.style.display = 'none';
                detailBtn.textContent = '详情';
                detailBtn.classList.remove('btn-secondary');
                detailBtn.classList.add('btn-info');
            }
        }

        async function updateTaskStatus(taskId, status) {
            try {
                const data = await apiRequest(`/api/tasks/${taskId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });
                showAlert(`任务状态更新成功!`, 'success');
                loadTasks(); // 重新加载任务列表
            } catch (error) {
                showAlert(`更新任务状态失败: ${error.message}`, 'error');
            }
        }

        function showCreateTaskForm() {
            document.getElementById('createTaskForm').style.display = 'block';
        }

        function hideCreateTaskForm() {
            document.getElementById('createTaskForm').style.display = 'none';
            // 清空表单
            document.getElementById('taskPrompt').value = '';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskDependencies').value = '';
        }

        async function createTask() {
            const prompt = document.getElementById('taskPrompt').value.trim();
            if (!prompt) {
                showAlert('请输入任务描述', 'error');
                return;
            }

            try {
                const taskData = {
                    prompt: prompt,
                    priority: document.getElementById('taskPriority').value,
                    dependencies: document.getElementById('taskDependencies').value.trim()
                };

                const data = await apiRequest('/api/tasks', {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });

                showAlert('任务创建成功!', 'success');
                hideCreateTaskForm();
                loadTasks(); // 重新加载任务列表
                showResponse(data.data, '新创建的任务');
            } catch (error) {
                showAlert(`创建任务失败: ${error.message}`, 'error');
            }
        }

        // 项目管理功能
        async function initializeProject() {
            const projectName = document.getElementById('projectName').value.trim();
            if (!projectName) {
                showAlert('请输入项目名称', 'error');
                return;
            }

            try {
                const projectData = {
                    projectName: projectName,
                    projectDescription: document.getElementById('projectDescription').value.trim(),
                    projectVersion: document.getElementById('projectVersion').value.trim() || '1.0.0',
                    yes: true
                };

                const data = await apiRequest('/api/projects/initialize', {
                    method: 'POST',
                    body: JSON.stringify(projectData)
                });

                showAlert('项目初始化成功!', 'success');
                showResponse(data.data, '项目初始化结果');
            } catch (error) {
                showAlert(`项目初始化失败: ${error.message}`, 'error');
            }
        }

        async function parsePrd() {
            const prdContent = document.getElementById('prdContent').value.trim();
            if (!prdContent) {
                showAlert('请输入PRD内容', 'error');
                return;
            }

            try {
                const prdData = {
                    input: prdContent,
                    numTasks: parseInt(document.getElementById('numTasks').value) || 5
                };

                const data = await apiRequest('/api/projects/parse-prd', {
                    method: 'POST',
                    body: JSON.stringify(prdData)
                });

                showAlert('PRD解析成功!', 'success');
                showResponse(data.data, 'PRD解析结果');
            } catch (error) {
                showAlert(`PRD解析失败: ${error.message}`, 'error');
            }
        }

        // 文件上传功能
        function setupFileUpload() {
            const uploadArea = document.getElementById('fileUploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({ target: { files } });
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showAlert('文件大小不能超过10MB', 'error');
                return;
            }

            if (!file.type.startsWith('text/') && !file.name.endsWith('.txt') && !file.name.endsWith('.md')) {
                showAlert('请选择文本文件 (.txt, .md)', 'error');
                return;
            }

            selectedFile = file;
            document.getElementById('uploadBtn').disabled = false;
            
            const uploadArea = document.getElementById('fileUploadArea');
            uploadArea.innerHTML = `
                <div>
                    <h4>📄 已选择文件</h4>
                    <p>${file.name} (${(file.size / 1024).toFixed(1)} KB)</p>
                </div>
            `;
            
            showAlert(`文件 "${file.name}" 已选择`, 'success');
        }

        async function uploadPrdFile() {
            if (!selectedFile) {
                showAlert('请先选择文件', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('numTasks', document.getElementById('numTasks').value || '5');

                const data = await apiRequest('/api/projects/parse-prd-file', {
                    method: 'POST',
                    headers: {
                        'X-API-Key': config.apiKey
                        // 不设置 Content-Type，让浏览器自动设置
                    },
                    body: formData
                });

                showAlert('PRD文件解析成功!', 'success');
                showResponse(data.data, 'PRD文件解析结果');
            } catch (error) {
                showAlert(`PRD文件解析失败: ${error.message}`, 'error');
            }
        }

        // AI研究功能
        async function performResearch() {
            const query = document.getElementById('researchQuery').value.trim();
            if (!query) {
                showAlert('请输入研究问题', 'error');
                return;
            }

            try {
                const researchData = {
                    query: query,
                    detailLevel: document.getElementById('detailLevel').value,
                    customContext: document.getElementById('customContext').value.trim()
                };

                const data = await apiRequest('/api/research', {
                    method: 'POST',
                    body: JSON.stringify(researchData)
                });

                // 安全地访问响应数据
                const responseData = data && data.data ? data.data : {};
                const result = responseData.result || responseData.response || responseData.content || '';
                
                const resultsContainer = document.getElementById('researchResults');
                
                if (result) {
                    resultsContainer.innerHTML = `
                        <div class="config-section">
                            <h4>🔍 研究问题</h4>
                            <p>${query}</p>
                            
                            <h4>📝 研究结果</h4>
                            <div class="response-area" style="
                                white-space: pre-wrap; 
                                background: #f8f9fa; 
                                padding: 15px; 
                                border-radius: 8px; 
                                border-left: 4px solid #007bff;
                            ">${result}</div>
                            
                            ${responseData.sources ? `
                                <h4>📚 数据源</h4>
                                <ul>
                                    ${responseData.sources.map(source => `<li>${source}</li>`).join('')}
                                </ul>
                            ` : ''}
                            
                            <p><small>生成时间: ${responseData.timestamp ? new Date(responseData.timestamp).toLocaleString() : new Date().toLocaleString()}</small></p>
                        </div>
                    `;
                    showAlert('AI研究完成!', 'success');
                } else {
                    // 显示错误信息
                    resultsContainer.innerHTML = `
                        <div class="config-section">
                            <h4>🔍 研究问题</h4>
                            <p>${query}</p>
                            
                            <div class="alert alert-warning">
                                <h4>⚠️ 研究服务暂时不可用</h4>
                                <p>当前配置的AI模型 (Qianwen) 在您的地区可能不受支持。</p>
                                <p><strong>建议解决方案：</strong></p>
                                <ul>
                                    <li>联系管理员配置其他AI模型（如OpenAI、Anthropic等）</li>
                                    <li>检查API密钥和网络连接</li>
                                    <li>或暂时使用其他功能</li>
                                </ul>
                                <p><small>错误详情: ${data && data.error ? data.error : '服务不可用'}</small></p>
                            </div>
                        </div>
                    `;
                    showAlert('AI研究服务当前不可用', 'warning');
                }
            } catch (error) {
                console.error('Research API Error:', error);
                
                // 显示详细的错误信息
                const resultsContainer = document.getElementById('researchResults');
                resultsContainer.innerHTML = `
                    <div class="config-section">
                        <h4>🔍 研究问题</h4>
                        <p>${query}</p>
                        
                        <div class="alert alert-danger">
                            <h4>❌ 研究请求失败</h4>
                            <p><strong>错误信息:</strong> ${error.message}</p>
                            
                            <h5>🔧 可能的解决方案：</h5>
                            <ul>
                                <li><strong>API配置问题:</strong> 检查服务器是否正常运行</li>
                                <li><strong>模型配置问题:</strong> 当前使用的是Qianwen模型，可能在您的地区不受支持</li>
                                <li><strong>网络问题:</strong> 检查网络连接和防火墙设置</li>
                                <li><strong>API密钥问题:</strong> 检查AI服务的API密钥配置</li>
                            </ul>
                            
                            <h5>📋 建议的替代方案：</h5>
                            <ul>
                                <li>配置OpenAI API密钥 (GPT-4, GPT-3.5等)</li>
                                <li>配置Anthropic API密钥 (Claude系列)</li>
                                <li>使用本地运行的Ollama模型</li>
                                <li>联系系统管理员检查服务器配置</li>
                            </ul>
                            
                            <p><small>错误时间: ${new Date().toLocaleString()}</small></p>
                        </div>
                    </div>
                `;
                
                showAlert(`AI研究失败: ${error.message}`, 'error');
            }
        }

        // API文档功能
        async function loadApiDocs() {
            try {
                const data = await apiRequest('/debug/routes');
                
                const container = document.getElementById('apiDocsContainer');
                container.innerHTML = `
                    <div class="config-section">
                        <h4>📋 可用API端点</h4>
                        <ul>
                            ${data.availableRoutes.map(route => `<li><code>${route}</code></li>`).join('')}
                        </ul>
                        
                        <h4>🧪 测试命令</h4>
                        <div class="response-area">${JSON.stringify(data.testCommands, null, 2)}</div>
                        
                        <h4>🔧 集成状态</h4>
                        <div class="alert alert-info">
                            <strong>状态:</strong> ${data.taskMasterIntegration.status}<br>
                            <strong>描述:</strong> ${data.taskMasterIntegration.description}
                        </div>
                    </div>
                `;
                
                showAlert('API文档加载成功!', 'success');
            } catch (error) {
                showAlert(`加载API文档失败: ${error.message}`, 'error');
            }
        }

        // 新增配置功能

        // 加载AI配置信息
        async function loadAiConfig() {
            try {
                // 模拟AI配置数据（实际可以通过API获取）
                const aiConfig = {
                    main: {
                        model: 'qwen-turbo-latest',
                        baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1'
                    },
                    research: {
                        model: 'qwen-turbo-latest', 
                        baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1'
                    },
                    fallback: {
                        model: 'qwen-turbo-latest',
                        baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1'
                    }
                };

                // 更新显示
                document.getElementById('currentMainModel').textContent = aiConfig.main.model;
                document.getElementById('currentMainBaseUrl').textContent = aiConfig.main.baseUrl;
                document.getElementById('currentResearchModel').textContent = aiConfig.research.model;
                document.getElementById('currentResearchBaseUrl').textContent = aiConfig.research.baseUrl;
                document.getElementById('currentFallbackModel').textContent = aiConfig.fallback.model;
                document.getElementById('currentFallbackBaseUrl').textContent = aiConfig.fallback.baseUrl;
                
                showAlert('AI配置信息已刷新!', 'success');
                
                // 可以添加API调用来获取真实配置
                // const data = await apiRequest('/api/config/ai');
                
            } catch (error) {
                showAlert(`加载AI配置失败: ${error.message}`, 'error');
            }
        }

        // 加载项目信息
        async function loadProjectInfo() {
            try {
                // 模拟项目信息，实际可以通过API获取
                const projectInfo = {
                    name: "Task Master Web API",
                    version: "1.0.0",
                    status: "运行中",
                    tasksCount: 15,
                    completedTasks: 8,
                    currentTag: "master"
                };

                const container = document.getElementById('projectInfo');
                container.innerHTML = `
                    <div class="alert alert-info">
                        <strong>📋 项目名称:</strong> ${projectInfo.name}<br>
                        <strong>🔖 版本:</strong> ${projectInfo.version}<br>
                        <strong>⚡ 状态:</strong> ${projectInfo.status}<br>
                        <strong>📊 任务统计:</strong> ${projectInfo.completedTasks}/${projectInfo.tasksCount} 已完成<br>
                        <strong>🏷️ 当前标签:</strong> ${projectInfo.currentTag}
                    </div>
                `;
                
                showAlert('项目信息加载成功!', 'success');
            } catch (error) {
                showAlert(`加载项目信息失败: ${error.message}`, 'error');
            }
        }

        // 加载标签信息
        async function loadTagsInfo() {
            try {
                const data = await apiRequest('/api/tags');
                
                const container = document.getElementById('tagsInfo');
                if (data.data && data.data.tags) {
                    const tagsHtml = data.data.tags.map(tag => `
                        <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>${tag.name}</strong> 
                            ${tag.current ? '<span style="color: #28a745;">(当前)</span>' : ''}
                            <br>
                            <small>任务数: ${tag.taskCount || 0} | 
                            完成: ${tag.completedTasks || 0} | 
                            创建时间: ${tag.createdAt ? new Date(tag.createdAt).toLocaleDateString() : '未知'}</small>
                            ${tag.description ? `<br><small style="color: #6c757d;">${tag.description}</small>` : ''}
                        </div>
                    `).join('');
                    
                    container.innerHTML = tagsHtml;
                } else {
                    container.innerHTML = '<p>暂无标签信息</p>';
                }
                
                showAlert('标签信息加载成功!', 'success');
            } catch (error) {
                showAlert(`加载标签信息失败: ${error.message}`, 'error');
            }
        }

        // 加载API统计信息
        async function loadApiStats() {
            try {
                // 模拟API统计数据
                const stats = {
                    totalRequests: 1247,
                    successfulRequests: 1198,
                    failedRequests: 49,
                    averageResponseTime: "245ms",
                    uptime: "99.8%",
                    lastRequestTime: new Date().toISOString()
                };

                const container = document.getElementById('apiStats');
                container.innerHTML = `
                    <div class="alert alert-info">
                        <strong>📈 总请求数:</strong> ${stats.totalRequests}<br>
                        <strong>✅ 成功请求:</strong> ${stats.successfulRequests}<br>
                        <strong>❌ 失败请求:</strong> ${stats.failedRequests}<br>
                        <strong>⏱️ 平均响应时间:</strong> ${stats.averageResponseTime}<br>
                        <strong>🔄 运行时间:</strong> ${stats.uptime}<br>
                        <strong>🕐 最后请求:</strong> ${new Date(stats.lastRequestTime).toLocaleString()}
                    </div>
                `;
                
                showAlert('API统计信息加载成功!', 'success');
            } catch (error) {
                showAlert(`加载API统计失败: ${error.message}`, 'error');
            }
        }


    </script>
</body>
</html> 