# Code Quality Analysis System

This system provides lightweight, post-session code quality analysis for Claude Code sessions in Task Master.

## Overview

The quality analysis system automatically evaluates code generated by Claude Code sessions and provides:
- **Quality scores** (1-10 scale)
- **Complexity metrics** (cyclomatic complexity)
- **Linting results** (using project's Biome configuration)
- **Task alignment analysis** (how well code matches task requirements)
- **Actionable insights** and recommendations

## Components

### 1. CodeQualityAnalyzer (`code-quality-analyzer.js`)
Core analysis engine that:
- Analyzes changed files from git diff
- Calculates structural metrics (lines, comments, complexity)
- Runs Biome linting (if configured)
- Evaluates task alignment using keyword matching
- Generates overall quality scores

### 2. Quality Insights Formatter (`quality-insights-formatter.js`)
Formats analysis results for different contexts:
- **Task updates**: Detailed reports added to task details
- **PR descriptions**: Concise quality summaries for pull requests
- **Console output**: Human-readable terminal output

### 3. Session Completion Hook Integration
Extended `session-completion.js` to:
- Run quality analysis after each Claude Code session
- Update tasks with quality metrics
- Include quality information in PR descriptions
- Generate actionable recommendations

## Features

### Metrics Analyzed

**Structural Metrics:**
- Lines of code (excluding blanks)
- Comment ratio
- Average line length
- Function/class counts

**Complexity Analysis:**
- Cyclomatic complexity per file
- Complexity distribution (low/medium/high/very-high)
- Average complexity across files

**JavaScript/TypeScript Specific:**
- Function and class counts
- Import/export analysis
- Async/await usage
- Console.log usage
- TODO comment detection

**Task Alignment:**
- Keyword coverage from task description
- File relevance to task scope
- Implementation scope assessment

**Linting Integration:**
- Uses existing Biome configuration
- Reports errors and warnings
- Integrates with project standards

### Quality Scoring (1-10 Scale)

**Scoring Factors:**
- **Complexity**: Penalty for high complexity (>10-15)
- **Comments**: Bonus for good documentation (>20%), penalty for lack (<10%)
- **Linting**: Penalty for errors/warnings
- **Task Alignment**: Bonus for high keyword coverage (>70%)

**Score Interpretation:**
- **8-10**: Excellent quality
- **6-7**: Acceptable quality
- **1-5**: Needs improvement

## Usage

### Automatic Integration
Quality analysis runs automatically after Claude Code sessions when enabled in hook configuration:

```json
{
  "session-completion": {
    "enabled": true,
    "config": {
      "enableQualityAnalysis": true
    }
  }
}
```

### Manual Testing
Run the test script to verify functionality:
```bash
cd scripts/modules/flow/hooks/quality
node test-quality-analyzer.js
```

## Output Examples

### Console Output
```
🔍 Code Quality Analysis (45ms)
──────────────────────────────────────────────────
✅ Overall Score: 9/10
📁 Files: 2 (74 lines)
🔄 Avg Complexity: 8.0
📝 Comment Ratio: 4.5%
🔧 Linting: 0 errors, 1 warnings
✅ Task Alignment: 75%
```

### Task Update
Quality metrics are automatically added to task details:
```markdown
<quality-analysis added="2024-01-15T10:30:00Z">
✅ Quality Score: 9/10 (excellent) • 2 files • 74 lines

## Quality Analysis Summary
- **Overall Score:** 9/10
- **Files Analyzed:** 2
- **Total Lines:** 74
- **Analysis Time:** 45ms

## Code Metrics
- **Average Complexity:** 8.0
- **Comment Ratio:** 4.5%
- **Total Functions:** 8
</quality-analysis>
```

### PR Description Addition
```markdown
## 🔍 Code Quality Analysis

**Overall Score:** 9/10
**Complexity:** 8.0 avg
**Documentation:** 4.5% comments
**Linting:** ✅ Clean
**Task Alignment:** 75% keyword coverage
```

## Configuration

### Hook Configuration
In `scripts/modules/flow/hooks/config/default-config.json`:
```json
{
  "session-completion": {
    "config": {
      "enableQualityAnalysis": true,
      "autoUpdateTaskStatus": true,
      "autoCreatePR": true
    }
  }
}
```

### Analyzer Options
```javascript
const analyzer = new CodeQualityAnalyzer({
  enableBiomeAnalysis: true,      // Use Biome linting
  enableComplexityAnalysis: true, // Calculate complexity
  enableStructuralAnalysis: true, // Basic metrics
  enableTaskAlignment: true,      // Task matching
  maxAnalysisTimeMs: 10000       // Timeout protection
});
```

## File Support

**Analyzed File Types:**
- JavaScript (`.js`, `.jsx`)
- TypeScript (`.ts`, `.tsx`)
- JSON (`.json`)
- Markdown (`.md`)

**Excluded Paths:**
- `node_modules/`
- `.git/`
- `dist/`
- `build/`

## Performance

- **Analysis Time**: Typically 50-200ms for small changes
- **Memory Usage**: Minimal (processes files individually)
- **Timeout Protection**: 10-second maximum analysis time
- **Error Resilience**: Failures don't break session completion

## Integration Points

### With Task Master
- Updates task/subtask details with quality reports
- Generates insights for task recommendations
- Integrates with existing update mechanisms

### With Git Workflow
- Analyzes only changed files from session
- Works with worktree-based development
- Includes quality info in PR descriptions

### With Biome
- Uses existing project Biome configuration
- Respects project-specific linting rules
- Falls back gracefully if Biome unavailable

## Troubleshooting

### Common Issues

**Quality analysis not running:**
- Check hook configuration is enabled
- Verify session completion hook is active
- Check for errors in session completion logs

**Biome analysis failing:**
- Ensure `biome.json` exists in project root
- Verify Biome is installed (`npx biome --version`)
- Check file paths are supported by Biome

**No changes detected:**
- Verify git is tracking changes in worktree
- Check if files are in supported formats
- Ensure changes occurred during session

### Debug Mode
Enable detailed logging by setting:
```javascript
console.warn('Code quality analysis failed:', error.message);
```

## Future Enhancements

**Potential Improvements:**
- Support for more languages (Python, Go, etc.)
- Integration with additional linters (ESLint, Prettier)
- Test coverage analysis
- Security vulnerability scanning
- Performance benchmarking
- Custom quality rules per project
- Quality trend tracking over time

## Dependencies

- **Node.js**: Built-in modules (fs, path, child_process)
- **Biome**: Optional, for linting analysis
- **Git**: Required for change detection
- **Task Master**: Backend services for task updates 